## Data Model Documentation: `fato_documentos_fiscais`

Following the Star Schema standard, this model organizes information about fiscal documents (invoices, notes, etc.). The central fact table stores the key financial figures, while the surrounding dimension tables provide crucial context, including different roles for time, company, and location.

The model is designed to easily answer complex questions involving multiple parties (issuer, recipient, main entity) and various monetary values (services, ISS tax, discounts).



### Detailed Table Analysis

#### 1. Fact Table: `fato_documentos_fiscais`

The fact table, `fato_documentos_fiscais`, represents the core financial event: **an individual fiscal document**. This table holds all the measurable data points (metrics) that need to be aggregated: `valor_servicos`, `valor_total`, `valor_iss` (ISS tax amount), `base_calculo` (calculation base), `valor_deducoes` (deductions), and `valor_descontos` (discounts).

It contains unique identifiers (`numero_documento`, `access_key`, `numero_serie`) and connects to the dimensions using several foreign keys, notably using the same dimension multiple times for different roles:
* **Three** keys link to CNPJ dimensions: `cnpj_principal_key`, `cnpj_prestador_key` (service provider), and `cnpj_tomador_key` (service taker).
* **One** key links to the Date dimension: `data_emissao_key`.

#### 2. Dimensions and Their Roles

This fact table leverages five key dimensions, many of which play multiple roles:

| Dimension | Primary Key | Role(s) in Fact Table | Key Attributes |
| :--- | :--- | :--- | :--- |
| **dim_data** | `data_key` | Date of Issuance (`data_emissao_key`) | Year, Quarter, Month Name |
| **dim_empresa** | `cnpj` | Main Company CNPJ (`cnpj_principal_key`) | Business Name, State (UF), Registration |
| **dim_prestator_tornador** | `cnpj` | Provider CNPJ (`cnpj_prestador_key`), Taker CNPJ (`cnpj_tomador_key`) | Business Name, Type (prestator/tomador) |
| **dim_localidade** | `localidade_key` | Document Location (`localidade_key`) | Municipality, State (UF), CEP |
| **dim_tipo_documento** | `tipo_documento_key` | Document Context (`tipo_documento_key`) | Subtype, Category, Origin Label |

This structure facilitates analyses such as: "What is the total `valor_iss` generated by `cnpj_prestador_key` in the state defined by `localidade_key` during the second quarter of the year defined by `data_emissao_key`?"

### DBML Code (Diagram)

```dbml
Table fato_documentos_fiscais {
  documento_id varchar [pk]
  ingested_at timestamp
  numero_documento varchar
  numero_serie varchar
  codigo_autenticidade varchar
  aliquota_iss decimal
  base_calculo decimal
  valor_servicos decimal
  valor_total decimal
  valor_iss decimal
  valor_deducoes decimal
  valor_descontos decimal
  descricao_servicos text
  competencia varchar
  arquivo varchar
  caminho_completo varchar
  access_key varchar
  authorization_protocol varchar
  authorization_datetime timestamp
  label varchar

  // Foreign Keys (Dimensions are shared across the data model)
  cnpj_principal_key varchar [ref: > dim_empresa.cnpj]
  cnpj_prestador_key varchar [ref: > dim_prestator_tornador.cnpj]
  cnpj_tomador_key varchar [ref: > dim_prestator_tornador.cnpj]
  tipo_documento_key int [ref: > dim_tipo_documento.tipo_documento_key]
  data_emissao_key int [ref: > dim_data.data_key]
  localidade_key int [ref: > dim_localidade.localidade_key]
}

Table dim_data {
  data_key int [pk]
  data_completa date
  ano int
  mes int
  trimestre int
  dia_mes int
  dia_semana int
  nome_mes varchar
  ano_mes varchar
}

Table dim_empresa {
  cnpj varchar [pk]
  razao_social varchar
  inscricao_estadual varchar
  inscricao_municipal varchar
  tipo_pessoa varchar
}

Table dim_prestator_tornador {
  cnpj varchar [pk]
  razao_social varchar
  tipo varchar
}

Table dim_localidade {
  localidade_key int [pk]
  municipio varchar
  uf varchar
  bairro varchar
  cep varchar
  logradouro varchar
  numero varchar
  complemento varchar
}

Table dim_tipo_documento {
  tipo_documento_key int [pk]
  tipo_documento varchar
  subtipo_documento varchar
  categoria varchar
  origem_label varchar
}
